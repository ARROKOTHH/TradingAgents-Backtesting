# 5.3 The Backtesting Engine

The ultimate goal of the analysis is to produce a testable trading strategy. This is handled by the backtesting engine, which is powered by the popular and powerful **`backtrader`** library.

The core logic for the engine resides in `Backtesting/backtesting.py`.

## The Role of `backtrader`

`backtrader` is a feature-rich Python framework for backtesting trading strategies. It handles the complexities of historical data management, event simulation, order execution, and performance analysis, allowing us to focus purely on the strategy's logic.

## The Strategy Generation Process

1.  **AI-Generated Code**: As described in the Core Workflow, the LLM generates Python code for a trading strategy. This code is specifically written to be compatible with the `backtrader` framework.

2.  **Strategy File**: The generated code is saved as a `.py` file in the `Strategy/` directory. A typical strategy file defines a class that inherits from `backtrader.Strategy` and implements methods like `__init__` (to set up indicators) and `next` (to define the trading logic for each time step).

3.  **The "Code Reviewer" - A Key Innovation**: LLMs, while powerful, are not perfect programmers. They often make small but consistent syntax errors when generating `backtrader` code (e.g., accessing indicators incorrectly). To solve this, we've implemented an automated **"Code Reviewer"**.
    -   **Function**: `auto_correct_backtrader_code` in `web/modules/strategy_backtesting.py`.
    -   **Mechanism**: This function runs *before* the backtest begins. It uses a set of predefined regular expressions to scan the AI-generated code and automatically fix the most common `backtrader` syntax mistakes.
    -   **Impact**: This significantly increases the success rate of the generated strategies, reducing the need for manual correction and saving time and LLM token costs.

## Running a Backtest

The `Backtesting/backtesting.py` script contains the `run_backtest` function, which is the heart of the engine. It performs the following steps:

1.  **Initialization**: Sets up the `backtrader` Cerebro engine.
2.  **Data Loading**: Fetches the historical stock data for the specified period.
3.  **Strategy Loading**: Dynamically imports the AI-generated strategy class from its file.
4.  **Execution**: Adds the data and strategy to the Cerebro engine and runs the simulation.
5.  **Analysis & Plotting**: Calculates key performance metrics (e.g., final portfolio value, Sharpe ratio) and generates a plot showing the price data, indicators, and buy/sell signals.
6.  **Results**: Returns the results and the plot to the Web UI for display.
